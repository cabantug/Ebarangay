<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Registrations â€¢ Admin</title>
    <link rel="stylesheet" href="assets/admin-styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <script src="assets/admin.js"></script>
    <script src="assets/admin-theme.js"></script>
    <header class="site-header">
      <div class="container header-inner">
        <h1 class="site-title">
          <i class="fas fa-user-plus"></i>
          Manage Registrations
        </h1>
        <nav class="site-nav">
          <a href="dashboard.html">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </a>
          <a href="certifications.html">
            <i class="fas fa-certificate"></i>
            Certifications
          </a>
          <a href="complaints.html">
            <i class="fas fa-exclamation-triangle"></i>
            Complaints
          </a>
          <a href="announcements.html">
            <i class="fas fa-bullhorn"></i>
            Announcements
          </a>
          <a href="accidents.html">
            <i class="fas fa-car-crash"></i>
            Accidents
          </a>
          <a href="residents.html">
            <i class="fas fa-users"></i>
            Residents
          </a>
          <a href="messages.html">
            <i class="fas fa-comments"></i>
            Messages
          </a>
          <a href="registrations.html" aria-current="page">
            <i class="fas fa-user-plus"></i>
            Registrations
          </a>
          <a href="#" id="signout">
            <i class="fas fa-sign-out-alt"></i>
            Sign out
          </a>
        </nav>
      </div>
    </header>

    <main class="container page">
      <div class="flex justify-between items-center mb-6">
        <h2>Registration Requests</h2>
      </div>

      <!-- Statistics Cards -->
      <div class="cards-grid mb-6">
        <div class="card info">
          <div class="flex items-center justify-between">
            <div>
              <h3>Total Requests</h3>
              <p id="stat-total">0</p>
            </div>
            <i class="fas fa-clipboard-list text-2xl text-info-color"></i>
          </div>
        </div>
        
        <div class="card warning">
          <div class="flex items-center justify-between">
            <div>
              <h3>Pending</h3>
              <p id="stat-pending">0</p>
            </div>
            <i class="fas fa-clock text-2xl text-warning-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Approved</h3>
              <p id="stat-approved">0</p>
            </div>
            <i class="fas fa-check-circle text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card danger">
          <div class="flex items-center justify-between">
            <div>
              <h3>Rejected</h3>
              <p id="stat-rejected">0</p>
            </div>
            <i class="fas fa-times-circle text-2xl text-danger-color"></i>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="form mb-6">
        <div class="fields">
          <div class="field">
            <label for="status">
              <i class="fas fa-filter"></i>
              Status
            </label>
            <select id="status">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div class="field">
            <label for="purok">
              <i class="fas fa-home"></i>
              Purok
            </label>
            <select id="purok">
              <option value="">All Puroks</option>
              <option value="1">Purok 1</option>
              <option value="2">Purok 2</option>
              <option value="3">Purok 3</option>
              <option value="4">Purok 4</option>
              <option value="5">Purok 5</option>
            </select>
          </div>
          <div class="field">
            <label for="search">
              <i class="fas fa-search"></i>
              Search
            </label>
            <input id="search" placeholder="Search by name or phone..." />
          </div>
        </div>
      </div>
      <p id="registrations-error" class="text-danger"></p>

      <!-- Registrations Table -->
      <div class="card">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Purok</th>
                <th>Address</th>
                <th>Status</th>
                <th>Submitted</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="registrations-table">
              <tr>
                <td colspan="8" class="text-center text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Registration Details Modal -->
    <div id="details-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-user"></i>
            Registration Details
          </h3>
          <button id="modal-close" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Dynamic content -->
        </div>
        <div class="modal-footer" id="modal-footer">
          <!-- Dynamic buttons -->
        </div>
      </div>
    </div>

    <script>
      let allRegistrations = [];
      let filteredRegistrations = [];
      let errorEl;
      
      function updateStats() {
        const stats = {
          total: allRegistrations.length,
          pending: allRegistrations.filter(r => r.status === 'Pending').length,
          approved: allRegistrations.filter(r => r.status === 'Approved').length,
          rejected: allRegistrations.filter(r => r.status === 'Rejected').length
        };
        
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-pending').textContent = stats.pending;
        document.getElementById('stat-approved').textContent = stats.approved;
        document.getElementById('stat-rejected').textContent = stats.rejected;
      }
      
      async function loadRegistrations() {
        try {
          errorEl.textContent = '';
          allRegistrations = await window.brgyAdmin.listRegistrations();
          renderRegistrations();
          updateStats();
        } catch (err) {
          errorEl.textContent = err.message || 'Unable to load registrations.';
        }
      }
      
      function renderRegistrations() {
        const statusFilter = document.getElementById('status').value;
        const purokFilter = document.getElementById('purok').value;
        const searchFilter = document.getElementById('search').value.toLowerCase();
        
        filteredRegistrations = allRegistrations.filter(req => {
          if (statusFilter && req.status !== statusFilter) return false;
          if (purokFilter && req.purok !== purokFilter) return false;
          if (searchFilter && !req.fullName.toLowerCase().includes(searchFilter) && !(req.phone || '').includes(searchFilter)) return false;
          return true;
        });
        
        const tbody = document.getElementById('registrations-table');
        
        if (filteredRegistrations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">No registration requests found</td></tr>';
          updateStats();
          return;
        }
        
        const rows = filteredRegistrations.map(req => {
          const statusClass = req.status === 'Pending' ? 'warning' : 
                             req.status === 'Approved' ? 'success' : 
                             req.status === 'Rejected' ? 'danger' : 'secondary';
          
          return `
            <tr>
              <td class="font-semibold">#${req.id}</td>
              <td class="font-medium">${req.fullName}</td>
              <td>${req.phone}</td>
              <td><span class="chip info">Purok ${req.purok}</span></td>
              <td class="max-w-xs truncate">${req.address}</td>
              <td><span class="chip ${statusClass}">${req.status}</span></td>
              <td class="text-sm">${new Date(req.submittedAt).toLocaleDateString()}</td>
              <td class="flex gap-2">
                ${req.status === 'Pending' ? `
                  <button class="btn btn-success btn-sm" data-act="approve" data-id="${req.id}">
                    <i class="fas fa-check"></i>
                    Approve
                  </button>
                  <button class="btn btn-danger btn-sm" data-act="reject" data-id="${req.id}">
                    <i class="fas fa-times"></i>
                    Reject
                  </button>
                  <button class="btn btn-info btn-sm" data-act="view" data-id="${req.id}">
                    <i class="fas fa-eye"></i>
                    View
                  </button>
                ` : `
                  <button class="btn btn-primary btn-sm" data-act="view" data-id="${req.id}">
                    <i class="fas fa-eye"></i>
                    View Details
                  </button>
                `}
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = rows;
        updateStats();
      }
      
      async function approveRegistration(id) {
        await window.brgyAdmin.changeRegistrationStatus(id, 'Approved');
        await loadRegistrations();
      }
      
      async function rejectRegistration(id) {
        await window.brgyAdmin.changeRegistrationStatus(id, 'Rejected');
        await loadRegistrations();
      }
      
      function showRegistrationDetails(id) {
        const request = allRegistrations.find(r => r.id === id);
        
        if (!request) return;
        
        const statusClass = request.status === 'Pending' ? 'warning' : 
                           request.status === 'Approved' ? 'success' : 
                           request.status === 'Rejected' ? 'danger' : 'secondary';
        
        document.getElementById('modal-body').innerHTML = `
          <div class="space-y-4">
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Full Name</label>
              <p class="text-gray-800">${request.fullName}</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="field">
                <label class="text-sm font-semibold text-gray-600">Birth Date</label>
                <p class="text-gray-800">${new Date(request.birthDate).toLocaleDateString()}</p>
              </div>
              <div class="field">
                <label class="text-sm font-semibold text-gray-600">Phone</label>
                <p class="text-gray-800">${request.phone}</p>
              </div>
            </div>
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Email</label>
              <p class="text-gray-800">${request.email ? request.email : '<span class="text-gray-400">Not provided</span>'}</p>
            </div>
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Address</label>
              <p class="text-gray-800">${request.address}</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="field">
                <label class="text-sm font-semibold text-gray-600">Purok</label>
                <p class="text-gray-800"><span class="chip info">Purok ${request.purok}</span></p>
              </div>
              <div class="field">
                <label class="text-sm font-semibold text-gray-600">Status</label>
                <p><span class="chip ${statusClass}">${request.status}</span></p>
              </div>
            </div>
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Occupation</label>
              <p class="text-gray-800">${request.occupation ? request.occupation : '<span class="text-gray-400">Not provided</span>'}</p>
            </div>
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Reason for Registration</label>
              <p class="text-gray-800">${request.reason ? request.reason : '<span class="text-gray-400">Not provided</span>'}</p>
            </div>
            <div class="field">
              <label class="text-sm font-semibold text-gray-600">Submitted</label>
              <p class="text-gray-800">${new Date(request.submittedAt).toLocaleString()}</p>
            </div>
          </div>
        `;
        
        let footerHTML = '<button id="modal-close-btn" class="btn btn-secondary">Close</button>';
        
        if (request.status === 'Pending') {
          footerHTML += `
            <button class="btn btn-danger" data-act="reject" data-id="${request.id}">
              <i class="fas fa-times"></i>
              Reject
            </button>
            <button class="btn btn-success" data-act="approve" data-id="${request.id}">
              <i class="fas fa-check"></i>
              Approve
            </button>
          `;
        }
        
        document.getElementById('modal-footer').innerHTML = footerHTML;
        
        // Add event listeners for footer buttons
        document.getElementById('modal-close-btn').addEventListener('click', hideModal);
        document.querySelectorAll('#modal-footer button[data-act]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = btn.getAttribute('data-act');
            const reqId = parseInt(btn.getAttribute('data-id'));
            hideModal();
            
            if (action === 'approve') {
              if (confirm('Are you sure you want to approve this registration request?')) {
                approveRegistration(reqId);
              }
            } else if (action === 'reject') {
              if (confirm('Are you sure you want to reject this registration request?')) {
                rejectRegistration(reqId);
              }
            }
          });
        });
        
        document.getElementById('details-modal').classList.add('active');
      }
      
      function hideModal() {
        document.getElementById('details-modal').classList.remove('active');
      }
      
      document.addEventListener('DOMContentLoaded', async function() {
        errorEl = document.getElementById('registrations-error');
        await window.brgyAdmin.requireAuth();
        await loadRegistrations();
        
        document.getElementById('status').addEventListener('change', renderRegistrations);
        document.getElementById('purok').addEventListener('change', renderRegistrations);
        document.getElementById('search').addEventListener('input', renderRegistrations);
        
        document.body.addEventListener('click', async function(e) {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          
          const id = parseInt(btn.getAttribute('data-id'));
          const action = btn.getAttribute('data-act');
          
          if (action === 'approve' && confirm('Are you sure you want to approve this registration request?')) {
            await approveRegistration(id);
          } else if (action === 'reject' && confirm('Are you sure you want to reject this registration request?')) {
            await rejectRegistration(id);
          } else if (action === 'view') {
            showRegistrationDetails(id);
          }
        });
        
        document.getElementById('modal-close').addEventListener('click', hideModal);
        document.getElementById('details-modal').addEventListener('click', function(e) {
          if (e.target.id === 'details-modal') {
            hideModal();
          }
        });
        
        document.getElementById('signout').addEventListener('click', function(e) {
          e.preventDefault();
          window.brgyAdmin.logout();
          window.location.href = 'index.html';
        });
      });
    </script>
  </body>
</html>
