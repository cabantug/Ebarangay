<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Residents â€¢ Admin</title>
    <link rel="stylesheet" href="assets/admin-styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <script src="assets/admin.js"></script>
    <script src="assets/admin-theme.js"></script>
    <script>
      let allResidents = [];
      let filteredResidents = [];
      let errorEl;

      function render() {
        const tbody = document.querySelector('tbody');
        if (filteredResidents.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center text-gray-500">No residents found</td></tr>';
          return;
        }

        const rows = filteredResidents
          .map(
            (r) => `
          <tr>
            <td class="font-semibold">${r.id}</td>
            <td class="font-medium">${r.name}</td>
            <td>${r.age}</td>
            <td><span class="chip info">Purok ${r.purok}</span></td>
            <td class="max-w-xs truncate">${r.address}</td>
            <td class="flex gap-2">
              <button class="btn btn-primary btn-sm" data-act="edit" data-id="${r.id}">
                <i class="fas fa-edit"></i>
                Edit
              </button>
              <button class="btn btn-warning btn-sm" data-act="archive" data-id="${r.id}">
                <i class="fas fa-archive"></i>
                Archive
              </button>
              <button class="btn btn-info btn-sm" data-act="view" data-id="${r.id}">
                <i class="fas fa-eye"></i>
                View
              </button>
            </td>
          </tr>
        `,
          )
          .join('');
        tbody.innerHTML = rows;
      }

      function filterResidents() {
        const searchQuery = document.getElementById('rq').value.toLowerCase();
        const purokFilter = document.getElementById('rp').value;

        filteredResidents = allResidents.filter((resident) => {
          const matchesSearch =
            searchQuery === '' ||
            resident.name.toLowerCase().includes(searchQuery) ||
            resident.address.toLowerCase().includes(searchQuery) ||
            resident.id.toLowerCase().includes(searchQuery);
          const matchesPurok = purokFilter === 'All' || resident.purok === purokFilter;

          return matchesSearch && matchesPurok && !resident.archived;
        });

        render();
        updateStats();
      }

      function updateStats() {
        const stats = {
          total: allResidents.filter((r) => !r.archived).length,
          purok1: allResidents.filter((r) => r.purok === '1' && !r.archived).length,
          purok2: allResidents.filter((r) => r.purok === '2' && !r.archived).length,
          purok3: allResidents.filter((r) => r.purok === '3' && !r.archived).length,
          purok4: allResidents.filter((r) => r.purok === '4' && !r.archived).length,
          purok5: allResidents.filter((r) => r.purok === '5' && !r.archived).length,
          archived: allResidents.filter((r) => r.archived).length,
        };

        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-purok1').textContent = stats.purok1;
        document.getElementById('stat-purok2').textContent = stats.purok2;
        document.getElementById('stat-purok3').textContent = stats.purok3;
        document.getElementById('stat-purok4').textContent = stats.purok4;
        document.getElementById('stat-purok5').textContent = stats.purok5;
        document.getElementById('stat-archived').textContent = stats.archived;
      }
      function showResidentModal(resident = null) {
        const modal = document.getElementById('resident-modal');

        if (resident) {
          document.getElementById('modal-title').textContent = 'Edit Resident';
          document.getElementById('resident-id').value = resident.id;
          document.getElementById('resident-name').value = resident.name;
          document.getElementById('resident-age').value = resident.age;
          document.getElementById('resident-purok').value = resident.purok;
          document.getElementById('resident-address').value = resident.address;
        } else {
          document.getElementById('modal-title').textContent = 'Add New Resident';
          document.getElementById('resident-form').reset();
          document.getElementById('resident-id').value = '';
        }

        modal.classList.add('active');
      }

      function hideResidentModal() {
        document.getElementById('resident-modal').classList.remove('active');
      }

      async function loadResidents() {
        try {
          errorEl.textContent = '';
          allResidents = await window.brgyAdmin.listResidents();
          filteredResidents = allResidents.filter((r) => !r.archived);
          render();
          updateStats();
        } catch (err) {
          errorEl.textContent = err.message || 'Unable to load residents.';
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        errorEl = document.getElementById('residents-error');
        await window.brgyAdmin.requireAuth();
        await loadResidents();

        render();
        updateStats();

        document.getElementById('rq').addEventListener('input', filterResidents);
        document.getElementById('rp').addEventListener('change', filterResidents);

        document.body.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;

          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');

          if (act === 'edit') {
            const resident = allResidents.find((r) => r.id === id);
            if (resident) showResidentModal(resident);
          }
          if (act === 'archive' && confirm('Archive this resident?')) {
            await window.brgyAdmin.archiveResident(id);
            await loadResidents();
          }
          if (act === 'view') {
            const resident = allResidents.find((r) => r.id === id);
            if (resident) {
              alert(
                `Resident Details:\n\nID: ${resident.id}\nName: ${resident.name}\nAge: ${resident.age}\nPurok: ${resident.purok}\nAddress: ${resident.address}\nArchived: ${
                  resident.archived ? 'Yes' : 'No'
                }`,
              );
            }
          }
        });

        document.getElementById('resident-form').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = document.getElementById('resident-id').value;
          const name = document.getElementById('resident-name').value.trim();
          const age = document.getElementById('resident-age').value;
          const purok = document.getElementById('resident-purok').value;
          const address = document.getElementById('resident-address').value.trim();

          if (!name || !age || !purok || !address) {
            alert('Please fill in all required fields.');
            return;
          }

          if (id) {
            await window.brgyAdmin.updateResident(id, {
              name,
              age: Number(age),
              purok,
              address,
            });
          } else {
            alert('Creating new residents is not implemented in the demo API.');
            return;
          }

          await loadResidents();
          hideResidentModal();
        });

        document.getElementById('modal-close').addEventListener('click', hideResidentModal);
        document.getElementById('modal-cancel').addEventListener('click', hideResidentModal);

        document.getElementById('resident-modal').addEventListener('click', (e) => {
          if (e.target.id === 'resident-modal') {
            hideResidentModal();
          }
        });

        document.getElementById('signout')?.addEventListener('click', (e) => {
          e.preventDefault();
          window.brgyAdmin.logout();
          window.location.href = 'index.html';
        });
      });
    </script>
    <header class="site-header">
      <div class="container header-inner">
        <h1 class="site-title">
          <i class="fas fa-users"></i>
          Manage Residents
        </h1>
        <nav class="site-nav">
          <a href="dashboard.html">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </a>
          <a href="certifications.html">
            <i class="fas fa-certificate"></i>
            Certifications
          </a>
          <a href="complaints.html">
            <i class="fas fa-exclamation-triangle"></i>
            Complaints
          </a>
          <a href="announcements.html">
            <i class="fas fa-bullhorn"></i>
            Announcements
          </a>
          <a href="accidents.html">
            <i class="fas fa-car-crash"></i>
            Accidents
          </a>
          <a href="residents.html" aria-current="page">
            <i class="fas fa-users"></i>
            Residents
          </a>
          <a href="messages.html">
            <i class="fas fa-comments"></i>
            Messages
          </a>
          <a href="registrations.html">
            <i class="fas fa-user-plus"></i>
            Registrations
          </a>
          <a href="#" id="signout">
            <i class="fas fa-sign-out-alt"></i>
            Sign out
          </a>
        </nav>
      </div>
      <p id="residents-error" class="text-danger"></p>
    </header>

    <main class="container page">
      <div class="flex justify-between items-center mb-6">
        <h2>Resident Management</h2>
        <button class="btn btn-primary" onclick="showResidentModal()">
          <i class="fas fa-plus"></i>
          Add Resident
        </button>
      </div>
      
      <!-- Statistics Cards -->
      <div class="cards-grid mb-6">
        <div class="card info">
          <div class="flex items-center justify-between">
            <div>
              <h3>Total Residents</h3>
              <p id="stat-total">0</p>
            </div>
            <i class="fas fa-users text-2xl text-info-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Purok 1</h3>
              <p id="stat-purok1">0</p>
            </div>
            <i class="fas fa-home text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Purok 2</h3>
              <p id="stat-purok2">0</p>
            </div>
            <i class="fas fa-home text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Purok 3</h3>
              <p id="stat-purok3">0</p>
            </div>
            <i class="fas fa-home text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Purok 4</h3>
              <p id="stat-purok4">0</p>
            </div>
            <i class="fas fa-home text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card success">
          <div class="flex items-center justify-between">
            <div>
              <h3>Purok 5</h3>
              <p id="stat-purok5">0</p>
            </div>
            <i class="fas fa-home text-2xl text-success-color"></i>
          </div>
        </div>
        
        <div class="card warning">
          <div class="flex items-center justify-between">
            <div>
              <h3>Archived</h3>
              <p id="stat-archived">0</p>
            </div>
            <i class="fas fa-archive text-2xl text-warning-color"></i>
          </div>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="form mb-6">
        <div class="fields">
          <div class="field">
            <label for="rq">
              <i class="fas fa-search"></i>
              Search
            </label>
            <input id="rq" placeholder="Search by name, address, or ID..." />
          </div>
          <div class="field">
            <label for="rp">
              <i class="fas fa-filter"></i>
              Purok
            </label>
            <select id="rp">
              <option value="All">All Puroks</option>
              <option value="1">Purok 1</option>
              <option value="2">Purok 2</option>
              <option value="3">Purok 3</option>
              <option value="4">Purok 4</option>
              <option value="5">Purok 5</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Residents Table -->
      <div class="card">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Age</th>
                <th>Purok</th>
                <th>Address</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="text-center text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Resident Modal -->
    <div id="resident-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modal-title" class="modal-title">Add New Resident</h3>
          <button id="modal-close" class="modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="resident-form" class="modal-body">
          <input type="hidden" id="resident-id" />
          
          <div class="field mb-4">
            <label for="resident-name">
              <i class="fas fa-user"></i>
              Full Name *
            </label>
            <input id="resident-name" type="text" required placeholder="Enter full name..." />
          </div>
          
          <div class="field mb-4">
            <label for="resident-age">
              <i class="fas fa-calendar"></i>
              Age *
            </label>
            <input id="resident-age" type="number" required placeholder="Enter age..." min="1" max="120" />
          </div>
          
          <div class="field mb-4">
            <label for="resident-purok">
              <i class="fas fa-home"></i>
              Purok *
            </label>
            <select id="resident-purok" required>
              <option value="">Select Purok</option>
              <option value="1">Purok 1</option>
              <option value="2">Purok 2</option>
              <option value="3">Purok 3</option>
              <option value="4">Purok 4</option>
              <option value="5">Purok 5</option>
            </select>
          </div>
          
          <div class="field mb-4">
            <label for="resident-address">
              <i class="fas fa-map-marker-alt"></i>
              Address *
            </label>
            <textarea id="resident-address" required placeholder="Enter complete address..." rows="3"></textarea>
          </div>
        </form>
        
        <div class="modal-footer">
          <button id="modal-cancel" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button type="submit" form="resident-form" class="btn btn-primary">
            <i class="fas fa-save"></i>
            Save Resident
          </button>
        </div>
      </div>
    </div>
  </body>
  </html>


